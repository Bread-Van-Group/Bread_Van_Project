{% extends "driver/layout.html" %}

{% block title %}Owner Report{% endblock %}

{% block head %}
  <link rel="stylesheet" href="{{ url_for('static', filename='styles/owner/report.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='styles/owner/homepage.css') }}">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  {{ super() }}
{% endblock %}

{% block content %}
<div class="page-wrapper">
  <!-- Sidebar Navigation -->
  <div class="sidebar">
    <div class="sidebar-logo">LOGO</div>
    <a class="sidebar-btn" href="{{ url_for('index_views.owner_homepage') }}">Dashboard</a>
    <a class="sidebar-btn active" href="{{ url_for('index_views.owner_report') }}">Reports</a>
    <a class="sidebar-btn" href="#">Inventory</a>
    <a class="sidebar-btn" href="#">Routes</a>
    <a class="sidebar-btn sidebar-logout" href="{{ url_for('auth_views.logout_action') }}">Logout</a>
  </div>

  <!-- Main Content Area -->
  <div class="content-wrapper">
    <div class="header">Welcome, Owner!</div>

    <div class="page-container">
      <div class="report-container">
        <div class="main-content-scrollable">
          <div class="content-card">

            <div class="report-header">
              <h1>Report</h1>
              <div class="report-actions">
                <div class="custom-dropdown">
                  <button class="filter-btn" id="dropdown-toggle">
                    Last 7 Days <span style="margin-left:6px;">▾</span>
                  </button>
                  <ul class="dropdown-menu" id="dropdown-menu">
                    <li data-value="week">Last 7 Days</li>
                    <li data-value="month">Last 30 Days</li>
                    <li data-value="year">Last Year</li>
                  </ul>
                </div>
              </div>
            </div>

            <!-- Charts -->
            <div class="charts-grid">
              <div class="chart-card">
                <h2>Average Order Value</h2>
                <canvas id="orderValueChart" width="400" height="200"></canvas>
              </div>
              <div class="chart-card">
                <h2>Customer Traffic</h2>
                <canvas id="trafficChart" width="400" height="200"></canvas>
              </div>
            </div>

            <!-- Tables -->
            <div class="tables-grid">
              <div class="table-card">
                <h2>Top-Selling Items</h2>
                <table>
                  <thead>
                    <tr><th>Rank</th><th>Item</th><th>Units Sold</th></tr>
                  </thead>
                  <tbody id="top-selling-body">
                    <tr><td colspan="3">Loading...</td></tr>
                  </tbody>
                </table>
              </div>
              <div class="table-card">
                <h2>Frequently Bought Together</h2>
                <table>
                  <thead>
                    <tr><th>Item 1</th><th>Item 2</th><th>Times Paired</th></tr>
                  </thead>
                  <tbody id="pairing-body">
                    <tr><td colspan="3">Loading...</td></tr>
                  </tbody>
                </table>
              </div>
            </div>

          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  .sidebar {
    display: flex;
    flex-direction: column;
  }
  .sidebar-logout {
    margin-top: auto;
    color: #e74c3c !important;
  }
  .sidebar-logout:hover {
    background-color: #e74c3c !important;
    color: white !important;
  }
</style>
{% endblock %}

{% block scripts %}
<script>
  let orderValueChart, trafficChart;

  // Initialise both Chart.js charts
  function initCharts() {
    const makeChart = (id, type, label, color) => new Chart(
      document.getElementById(id).getContext('2d'),
      {
        type,
        data: {
          labels: [],
          datasets: [{ label, data: [], backgroundColor: color, borderColor: color, fill: false }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: { y: { beginAtZero: true, ticks: { precision: 0 } } }
        }
      }
    );

    orderValueChart = makeChart('orderValueChart', 'bar',  'Avg Order Value ($)', 'rgba(54,162,235,0.7)');
    trafficChart    = makeChart('trafficChart',    'line', 'Transactions',         '#ff6384');
  }

  // Fetch report data from Flask API
  async function loadReport(period = 'week') {
    try {
      const res = await fetch(`/api/owner/report?period=${period}`);
      if (!res.ok) throw new Error(`Server error ${res.status}`);
      const data = await res.json();
      updateCharts(data);
      updateTables(data);
    } catch (err) {
      console.error('Report load failed:', err);
      alert('Failed to load report data. Check the console for details.');
    }
  }

  function updateCharts(data) {
    orderValueChart.data.labels                  = data.daily_labels;
    orderValueChart.data.datasets[0].data        = data.avg_order_values;
    orderValueChart.update();

    trafficChart.data.labels                     = data.daily_labels;
    trafficChart.data.datasets[0].data           = data.traffic;
    trafficChart.update();
  }

  function updateTables(data) {
    // Top-selling items
    const topBody = document.getElementById('top-selling-body');
    if (data.top_selling.length === 0) {
      topBody.innerHTML = '<tr><td colspan="3">No data yet</td></tr>';
    } else {
      topBody.innerHTML = data.top_selling
        .map(item => `<tr><td>${item.rank}</td><td>${item.name}</td><td>${item.quantity}</td></tr>`)
        .join('');
    }

    // Frequently bought together
    const pairingBody = document.getElementById('pairing-body');
    if (data.frequently_bought_together.length === 0) {
      pairingBody.innerHTML = '<tr><td colspan="3">No data yet</td></tr>';
    } else {
      pairingBody.innerHTML = data.frequently_bought_together
        .map(p => `<tr><td>${p.item1}</td><td>${p.item2}</td><td>${p.count}</td></tr>`)
        .join('');
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    initCharts();
    loadReport('week');

    const toggle = document.getElementById('dropdown-toggle');
    const menu   = document.getElementById('dropdown-menu');

    // Toggle menu open/closed
    toggle.addEventListener('click', (e) => {
      e.stopPropagation();
      menu.classList.toggle('open');
    });

    // Pick an option
    menu.querySelectorAll('li').forEach(li => {
      li.addEventListener('click', () => {
        toggle.innerHTML = li.textContent + ' <span style="margin-left:6px;">▾</span>';
        menu.classList.remove('open');
        loadReport(li.dataset.value);
      });
    });

    //Close if clicking outside
    document.addEventListener('click', () => menu.classList.remove('open'));
  });
</script>
{% endblock %}